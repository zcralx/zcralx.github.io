
(function(window, document) {
    function initialize() {
        addCSSRules();
        bindClickHandler();
        animateHearts();
    }

    function addCSSRules() {
        var style = document.createElement('style');
        style.type = 'text/css';

        try {
            style.appendChild(document.createTextNode('.heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: "";width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}'));
        } catch (e) {
            style.styleSheet.cssText = '.heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: "";width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}';
        }

        document.getElementsByTagName('head')[0].appendChild(style);
    }

    function bindClickHandler() {
        var originalOnClick = window.onclick;

        window.onclick = function(event) {
            if (typeof originalOnClick === 'function') {
                originalOnClick();
            }

            createHeart(event);
        };
    }

    function animateHearts() {
        function update() {
            for (var i = 0; i < hearts.length; i++) {
                var heart = hearts[i];

                if (heart.alpha <= 0) {
                    document.body.removeChild(heart.el);
                    hearts.splice(i, 1);
                } else {
                    heart.y--;
                    heart.scale += 0.004;
                    heart.alpha -= 0.013;
                    heart.el.style.cssText = 'left:' + heart.x + 'px;top:' + heart.y + 'px;opacity:' + heart.alpha + ';transform:scale(' + heart.scale + ',' + heart.scale + ') rotate(45deg);background:' + heart.color + ';z-index:99999';
                }
            }

            requestAnimationFrame(update);
        }

        var hearts = [];

        window.requestAnimationFrame = window.requestAnimationFrame ||
                                       window.webkitRequestAnimationFrame ||
                                       window.mozRequestAnimationFrame ||
                                       window.oRequestAnimationFrame ||
                                       window.msRequestAnimationFrame ||
                                       function(callback) {
                                           setTimeout(callback, 1000 / 60);
                                       };

        update();
    }

    function createHeart(event) {
        var heartElement = document.createElement('div');
        heartElement.className = 'heart';

        var heart = {
            el: heartElement,
            x: event.clientX - 5,
            y: event.clientY - 5,
            scale: 1,
            alpha: 1,
            color: getRandomColor()
        };

        hearts.push(heart);
        document.body.appendChild(heartElement);
    }

    function getRandomColor() {
        return 'rgb(' + Math.floor(255 * Math.random()) + ',' + Math.floor(255 * Math.random()) + ',' + Math.floor(255 * Math.random()) + ')';
    }

    initialize();
})(window, document);
